<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoTix Asset Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: var(--secondary-color);
        }
        .navbar-brand {
            color: white !important;
            font-weight: bold;
        }
        .main-content {
            min-height: calc(100vh - 160px);
        }
        .footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem 0;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .dropdown-results {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0; 
            z-index: 1000;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 0 0 0.25rem 0.25rem;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        mark {
            background-color: #ffeaa7;
            padding: 0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <style>
        /* ... (keep existing styles) ... */
    
        .dropdown-results {
            position: absolute;
            width: 100%;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 0 0 0.25rem 0.25rem;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
    
        .asset-icon.bg-plc { background-color: #007bff; }
        .asset-icon.bg-server { background-color: #28a745; }
        .asset-icon.bg-router { background-color: #ffc107; }
        .asset-icon.bg-switch { background-color: #17a2b8; }
        .asset-icon.bg-default { background-color: #6c757d; }
    
        .criticality-low { color: #28a745; }
        .criticality-medium { color: #ffc107; }
        .criticality-high { color: #fd7e14; }
        .criticality-critical { color: #dc3545; }
    
        .list-group-item:hover {
            background-color: #f8f9fa;
        }
    
        mark {
            background-color: #fff3cd;
            padding: 0.2em 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-network-wired me-2"></i>IoTix Asset Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Assets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Settings</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 main-content" x-data="assetSearch()">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title mb-4">Asset Search</h2>
                        
                        <!-- Toggle button for Advanced Search -->
                        <button class="btn btn-secondary mb-3" @click="toggleAdvancedSearch">
                            <i class="fas fa-search-plus me-2"></i>Advanced Search
                        </button>
                        
                        <!-- Simple search input (show when advanced search is not active) -->
                        <div x-show="!showAdvancedSearch" class="mb-4 position-relative">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input 
                                    type="text" 
                                    x-model="query" 
                                    @input.debounce.300ms="search()"
                                    @focus="showDropdown = true"
                                    @blur="setTimeout(() => showDropdown = false, 200)"
                                    placeholder="Search assets by type, serial number, IP address..." 
                                    class="form-control form-control-lg"
                                >
                            </div>
                            <div x-show="loading" class="position-absolute top-50 end-0 translate-middle-y me-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div x-show="showDropdown && results.length > 0" class="dropdown-results">
                                <ul class="list-group">
                                    <template x-for="asset in results.slice(0, 10)" :key="asset.id">
                                        <li class="list-group-item d-flex align-items-center" @mousedown="selectAsset(asset)">
                                            <div class="asset-icon me-3" :class="getAssetTypeIconClass(asset.asset_type)">
                                                <i :class="getAssetTypeIcon(asset.asset_type)"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong x-text="asset.asset_type"></strong>
                                                    <span :class="getCriticalityClass(asset.criticality)" x-text="asset.criticality"></span>
                                                </div>
                                                <small class="text-muted" x-text="`${asset.serial_number || ''} | ${asset.ip_address || ''} | ${asset.mac_address || ''}`"></small>
                                                <div class="mt-1">
                                                    <span class="badge bg-light text-dark me-1" x-text="asset.manufacturer"></span>
                                                    <span class="badge bg-light text-dark me-1" x-text="asset.site_name"></span>
                                                    <template x-if="getMatchedField(asset)">
                                                        <span class="badge bg-info text-dark" x-text="getMatchedField(asset)"></span>
                                                    </template>
                                                </div>
                                            </div>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
    
                        <!-- Advanced Search area -->
                        <div x-show="showAdvancedSearch" class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Advanced Search</h5>
                                <form @submit.prevent="performAdvancedSearch">
                                    <div>
                                        <template x-for="(criterion, index) in criteria" :key="index">
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-3">
                                                    <select class="form-select" x-model="criterion.field">
                                                        <option value="">Select Field</option>
                                                        <option value="asset_type">Asset Type</option>
                                                        <option value="manufacturer">Manufacturer</option>
                                                        <option value="site_name">Site Name</option>
                                                        <option value="criticality">Criticality</option>
                                                        <option value="ip_address">IP Address</option>
                                                        <option value="mac_address">MAC Address</option>
                                                        <option value="serial_number">Serial Number</option>
                                                        <option value="part_no">Part Number</option>
                                                        <option value="mcc_no">MCC Number</option>
                                                        <option value="network_zone">Network Zone</option>
                                                        <option value="data_classification">Data Classification</option>
                                                        <option value="compliance_requirements">Compliance Requirements</option>
                                                        <option value="cybersecurity_patch_status">Cybersecurity Patch Status</option>
                                                        <option value="risk_assessment_score">Risk Assessment Score</option>
                                                        <option value="asset_status">Asset Status</option>
                                                        <option value="installation_date">Installation Date</option>
                                                        <option value="last_maintenance_date">Last Maintenance Date</option>
                                                        <option value="next_scheduled_maintenance">Next Scheduled Maintenance</option>
                                                        <option value="warranty_expiration_date">Warranty Expiration Date</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <select class="form-select" x-model="criterion.operator">
                                                        <option value="=">=</option>
                                                        <option value="!=">!=</option>
                                                        <option value="contains">Contains</option>
                                                        <option value="starts_with">Starts with</option>
                                                        <option value="ends_with">Ends with</option>
                                                        <option value="regex">Regex</option>
                                                        <option value=">">></option>
                                                        <option value="<"><</option>
                                                        <option value=">=">>=</option>
                                                        <option value="<="><=</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" x-model="criterion.value" placeholder="Enter value">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-danger" @click="removeCriterion(index)" x-show="criteria.length > 1">Remove</button>
                                                </div>
                                            </div>
                                        </template>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-secondary" @click="addCriterion">Add Criterion</button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6>Boolean Options</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="secureLocation" x-model="booleanOptions.secure_location">
                                            <label class="form-check-label" for="secureLocation">Secure Location</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="remoteAccess" x-model="booleanOptions.remote_access">
                                            <label class="form-check-label" for="remoteAccess">Remote Access</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="syslog" x-model="booleanOptions.syslog">
                                            <label class="form-check-label" for="syslog">Syslog</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="obsolete" x-model="booleanOptions.obsolete">
                                            <label class="form-check-label" for="obsolete">Obsolete</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="useCustomQuery" x-model="useCustomQuery">
                                        <label class="form-check-label" for="useCustomQuery">Use Custom Query</label>
                                    </div>
                                    
                                    <div class="mb-3" x-show="useCustomQuery">
                                        <label for="customQuery" class="form-label">Custom Query</label>
                                        <textarea class="form-control" id="customQuery" rows="3" x-model="customQuery" placeholder="Enter custom SQL-like query"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <button type="submit" class="btn btn-primary">Search</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- Advanced search results grid -->
<!-- Add this after the advanced search form -->
<div x-show="showAdvancedSearch && advancedResults.length > 0" class="mt-4">
    <h5>Search Results</h5>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <template x-for="header in getGridHeaders()" :key="header">
                        <th @click="changeSort(header.toLowerCase().replace(' ', '_'))">
                            <span x-text="header"></span>
                            <i :class="{'fas fa-sort-up': sortField === header.toLowerCase().replace(' ', '_') && sortOrder === 'asc',
                                        'fas fa-sort-down': sortField === header.toLowerCase().replace(' ', '_') && sortOrder === 'desc',
                                        'fas fa-sort': sortField !== header.toLowerCase().replace(' ', '_')}"></i>
                        </th>
                    </template>
                </tr>
            </thead>
            <tbody>
                <template x-for="asset in advancedResults" :key="asset.id">
                    <tr @click="selectAsset(asset)">
                        <template x-for="attr in selectedAttributes" :key="attr">
                            <td x-text="asset[attr]"></td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
    
    <nav aria-label="Search results pages">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <template x-for="page in totalPages" :key="page">
                <li class="page-item" :class="{ 'active': currentPage === page }">
                    <a class="page-link" href="#" @click.prevent="changePage(page)" x-text="page"></a>
                </li>
            </template>
            <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>
</div>
</div>
</div>
</div>
</div>
</div>

   <!-- Modal -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-labelledby="assetModalLabel" aria-hidden="true" x-data="assetModalData()">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="assetModalLabel" x-text="asset.asset_type"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <button class="nav-link active" id="v-pills-identification-tab" data-bs-toggle="pill" data-bs-target="#v-pills-identification" type="button" role="tab">Asset Identification</button>
                            <button class="nav-link" id="v-pills-location-tab" data-bs-toggle="pill" data-bs-target="#v-pills-location" type="button" role="tab">Location Information</button>
                            <button class="nav-link" id="v-pills-technical-tab" data-bs-toggle="pill" data-bs-target="#v-pills-technical" type="button" role="tab">Technical Specifications</button>
                            <button class="nav-link" id="v-pills-network-tab" data-bs-toggle="pill" data-bs-target="#v-pills-network" type="button" role="tab">Network and Security</button>
                            <button class="nav-link" id="v-pills-maintenance-tab" data-bs-toggle="pill" data-bs-target="#v-pills-maintenance" type="button" role="tab">Maintenance and Support</button>
                            <button class="nav-link" id="v-pills-financial-tab" data-bs-toggle="pill" data-bs-target="#v-pills-financial" type="button" role="tab">Financial Information</button>
                            <button class="nav-link" id="v-pills-status-tab" data-bs-toggle="pill" data-bs-target="#v-pills-status" type="button" role="tab">Status and Criticality</button>
                            <button class="nav-link" id="v-pills-responsibility-tab" data-bs-toggle="pill" data-bs-target="#v-pills-responsibility" type="button" role="tab">Responsibility and Compliance</button>
                            <button class="nav-link" id="v-pills-additional-tab" data-bs-toggle="pill" data-bs-target="#v-pills-additional" type="button" role="tab">Additional Information</button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content" id="v-pills-tabContent">
                            <div class="tab-pane fade show active" id="v-pills-identification" role="tabpanel">
                                <h6 class="mb-3">Asset Identification</h6>
                                <div class="mb-3">
                                    <label for="asset_type" class="form-label">Asset or Component</label>
                                    <input type="text" class="form-control" id="asset_type" x-model="asset.asset_type">
                                </div>
                                <div class="mb-3">
                                    <label for="serial_number" class="form-label">Serial Number</label>
                                    <input type="text" class="form-control" id="serial_number" x-model="asset.serial_number">
                                </div>
                                <div class="mb-3">
                                    <label for="part_no" class="form-label">Part No</label>
                                    <input type="text" class="form-control" id="part_no" x-model="asset.part_no">
                                </div>
                                <div class="mb-3">
                                    <label for="product_range" class="form-label">Product Range</label>
                                    <input type="text" class="form-control" id="product_range" x-model="asset.product_range">
                                </div>
                                <div class="mb-3">
                                    <label for="card_type" class="form-label">Card Type</label>
                                    <input type="text" class="form-control" id="card_type" x-model="asset.card_type">
                                </div>
                                <div class="mb-3">
                                    <label for="part_description" class="form-label">Part Description</label>
                                    <textarea class="form-control" id="part_description" x-model="asset.part_description"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="manufacturer" class="form-label">Manufacturer</label>
                                    <input type="text" class="form-control" id="manufacturer" x-model="asset.manufacturer">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-location" role="tabpanel">
                                <h6 class="mb-3">Location Information</h6>
                                <div class="mb-3">
                                    <label for="site_id" class="form-label">Site ID</label>
                                    <input type="text" class="form-control" id="site_id" x-model="asset.site_id">
                                </div>
                                <div class="mb-3">
                                    <label for="site_name" class="form-label">Site Name</label>
                                    <input type="text" class="form-control" id="site_name" x-model="asset.site_name">
                                </div>
                                <div class="mb-3">
                                    <label for="area" class="form-label">Area</label>
                                    <input type="text" class="form-control" id="area" x-model="asset.area">
                                </div>
                                <div class="mb-3">
                                    <label for="site_type" class="form-label">Site Type</label>
                                    <select class="form-select" id="site_type" x-model="asset.site_type">
                                        <option value="">Select Site Type</option>
                                        <option value="Production">Production</option>
                                        <option value="Distribution">Distribution</option>
                                        <option value="Office">Office</option>
                                        <option value="Data Center">Data Center</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="mcc_no" class="form-label">MCC No</label>
                                    <input type="text" class="form-control" id="mcc_no" x-model="asset.mcc_no">
                                </div>
                                <div class="mb-3">
                                    <label for="mcc_location" class="form-label">MCC Location</label>
                                    <input type="text" class="form-control" id="mcc_location" x-model="asset.mcc_location">
                                </div>
                                <div class="mb-3">
                                    <label for="process_area" class="form-label">Process Area</label>
                                    <input type="text" class="form-control" id="process_area" x-model="asset.process_area">
                                </div>
                                <div class="mb-3">
                                    <label for="physical_location_coordinates" class="form-label">Physical Location Coordinates</label>
                                    <input type="text" class="form-control" id="physical_location_coordinates" x-model="asset.physical_location_coordinates">
                                </div>
                                <div class="mb-3">
                                    <label for="secure_location" class="form-label">Secure Location</label>
                                    <select class="form-select" id="secure_location" x-model="asset.secure_location">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-technical" role="tabpanel">
                                <h6 class="mb-3">Technical Specifications</h6>
                                <div class="mb-3">
                                    <label for="firmware_revision" class="form-label">Firmware Revision</label>
                                    <input type="text" class="form-control" id="firmware_revision" x-model="asset.firmware_revision">
                                </div>
                                <div class="mb-3">
                                    <label for="software_compiler" class="form-label">Software Compiler</label>
                                    <input type="text" class="form-control" id="software_compiler" x-model="asset.software_compiler">
                                </div>
                                <div class="mb-3">
                                    <label for="operating_system" class="form-label">Operating System</label>
                                    <input type="text" class="form-control" id="operating_system" x-model="asset.operating_system">
                                </div>
                                <div class="mb-3">
                                    <label for="os_version" class="form-label">OS Version</label>
                                    <input type="text" class="form-control" id="os_version" x-model="asset.os_version">
                                </div>
                                <div class="mb-3">
                                    <label for="power_supply" class="form-label">Power Supply</label>
                                    <input type="text" class="form-control" id="power_supply" x-model="asset.power_supply">
                                </div>
                                <div class="mb-3">
                                    <label for="ip_address" class="form-label">IP Address</label>
                                    <input type="text" class="form-control" id="ip_address" x-model="asset.ip_address">
                                </div>
                                <div class="mb-3">
                                    <label for="dns_name" class="form-label">DNS Name</label>
                                    <input type="text" class="form-control" id="dns_name" x-model="asset.dns_name">
                                </div>
                                <div class="mb-3">
                                    <label for="mac_address" class="form-label">MAC Address</label>
                                    <input type="text" class="form-control" id="mac_address" x-model="asset.mac_address">
                                </div>
                                <div class="mb-3">
                                    <label for="communication_protocols" class="form-label">Communication Protocols</label>
                                    <input type="text" class="form-control" id="communication_protocols" x-model="asset.communication_protocols">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-network" role="tabpanel">
                                <h6 class="mb-3">Network and Security</h6>
                                <div class="mb-3">
                                    <label for="remote_access" class="form-label">Remote Access</label>
                                    <select class="form-select" id="remote_access" x-model="asset.remote_access">
                                        <option value="">Select</option>
                                        <option value="Enabled">Enabled</option>
                                        <option value="Disabled">Disabled</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="syslog" class="form-label">Syslog</label>
                                    <select class="form-select" id="syslog" x-model="asset.syslog">
                                        <option value="">Select</option>
                                        <option value="Enabled">Enabled</option>
                                        <option value="Disabled">Disabled</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="network_zone" class="form-label">Network Zone</label>
                                    <input type="text" class="form-control" id="network_zone" x-model="asset.network_zone">
                                </div>
                                <div class="mb-3">
                                    <label for="cybersecurity_patch_status" class="form-label">Cybersecurity Patch Status</label>
                                    <input type="text" class="form-control" id="cybersecurity_patch_status" x-model="asset.cybersecurity_patch_status">
                                </div>
                                <div class="mb-3">
                                    <label for="last_vulnerability_scan_date" class="form-label">Last Vulnerability Scan Date</label>
                                    <input type="date" class="form-control" id="last_vulnerability_scan_date" x-model="asset.last_vulnerability_scan_date">
                                </div>
                                <div class="mb-3">
                                    <label for="risk_assessment_score" class="form-label">Risk Assessment Score</label>
                                    <input type="number" class="form-control" id="risk_assessment_score" x-model="asset.risk_assessment_score">
                                </div>
                                <div class="mb-3">
                                    <label for="data_classification" class="form-label">Data Classification</label>
                                    <select class="form-select" id="data_classification" x-model="asset.data_classification">
                                        <option value="">Select</option>
                                        <option value="Public">Public</option>
                                        <option value="Internal">Internal</option>
                                        <option value="Confidential">Confidential</option>
                                        <option value="Restricted">Restricted</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-maintenance" role="tabpanel">
                                <h6 class="mb-3">Maintenance and Support</h6>
                                <div class="mb-3">
                                    <label for="installation_date" class="form-label">Installation Date</label>
                                    <input type="date" class="form-control" id="installation_date" x-model="asset.installation_date">
                                </div>
                                <div class="mb-3">
                                    <label for="last_maintenance_date" class="form-label">Last Maintenance Date</label>
                                    <input type="date" class="form-control" id="last_maintenance_date" x-model="asset.last_maintenance_date">
                                </div>
                                <div class="mb-3">
                                    <label for="next_scheduled_maintenance" class="form-label">Next Scheduled Maintenance</label>
                                    <input type="date" class="form-control" id="next_scheduled_maintenance" x-model="asset.next_scheduled_maintenance">
                                </div>
                                <div class="mb-3">
                                    <label for="warranty_expiration_date" class="form-label">Warranty Expiration Date</label>
                                    <input type="date" class="form-control" id="warranty_expiration_date" x-model="asset.warranty_expiration_date">
                                </div>
                                <div class="mb-3">
                                    <label for="change_management" class="form-label">Change Management</label>
                                    <textarea class="form-control" id="change_management" x-model="asset.change_management"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="vendor_support_contract" class="form-label">Vendor Support Contract</label>
                                    <input type="text" class="form-control" id="vendor_support_contract" x-model="asset.vendor_support_contract">
                                </div>
                                <div class="mb-3">
                                    <label for="support_contract_expiration" class="form-label">Support Contract Expiration</label>
                                    <input type="date" class="form-control" id="support_contract_expiration" x-model="asset.support_contract_expiration">
                                </div>
                                <div class="mb-3">
                                    <label for="backup_frequency" class="form-label">Backup Frequency</label>
                                    <select class="form-select" id="backup_frequency" x-model="asset.backup_frequency">
                                        <option value="">Select Frequency</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Quarterly">Quarterly</option>
                                        <option value="Annually">Annually</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-financial" role="tabpanel">
                                <h6 class="mb-3">Financial Information</h6>
                                <div class="mb-3">
                                    <label for="purchase_cost" class="form-label">Purchase Cost</label>
                                    <input type="number" step="0.01" class="form-control" id="purchase_cost" x-model="asset.purchase_cost">
                                </div>
                                <div class="mb-3">
                                    <label for="depreciation_value" class="form-label">Depreciation Value</label>
                                    <input type="number" step="0.01" class="form-control" id="depreciation_value" x-model="asset.depreciation_value">
                                </div>
                                <div class="mb-3">
                                    <label for="expected_lifespan" class="form-label">Expected Lifespan (years)</label>
                                    <input type="number" class="form-control" id="expected_lifespan" x-model="asset.expected_lifespan">
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-status" role="tabpanel">
                                <h6 class="mb-3">Status and Criticality</h6>
                                <div class="mb-3">
                                    <label for="asset_status" class="form-label">Asset Status</label>
                                    <select class="form-select" id="asset_status" x-model="asset.asset_status">
                                        <option value="">Select Status</option>
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Retired">Retired</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="obsolete" class="form-label">Obsolete</label>
                                    <select class="form-select" id="obsolete" x-model="asset.obsolete">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="criticality" class="form-label">Criticality</label>
                                    <select class="form-select" id="criticality" x-model="asset.criticality">
                                        <option value="">Select Criticality</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-responsibility" role="tabpanel">
                                <h6 class="mb-3">Responsibility and Compliance</h6>
                                <div class="mb-3">
                                    <label for="responsible_department" class="form-label">Responsible Department</label>
                                    <input type="text" class="form-control" id="responsible_department" x-model="asset.responsible_department">
                                </div>
                                <div class="mb-3">
                                    <label for="primary_contact_person" class="form-label">Primary Contact Person</label>
                                    <input type="text" class="form-control" id="primary_contact_person" x-model="asset.primary_contact_person">
                                </div>
                                <div class="mb-3">
                                    <label for="backup_contact_person" class="form-label">Backup Contact Person</label>
                                    <input type="text" class="form-control" id="backup_contact_person" x-model="asset.backup_contact_person">
                                </div>
                                <div class="mb-3">
                                    <label for="compliance_requirements" class="form-label">Compliance Requirements</label>
                                    <textarea class="form-control" id="compliance_requirements" x-model="asset.compliance_requirements"></textarea>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="v-pills-additional" role="tabpanel">
                                <h6 class="mb-3">Additional Information</h6>
                                <div class="mb-3">
                                    <label for="custom_configurations" class="form-label">Custom Configurations</label>
                                    <textarea class="form-control" id="custom_configurations" x-model="asset.custom_configurations"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="connected_devices" class="form-label">Connected Devices</label>
                                    <textarea class="form-control" id="connected_devices" x-model="asset.connected_devices"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="failure_history" class="form-label">Failure History</label>
                                    <textarea class="form-control" id="failure_history" x-model="asset.failure_history"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="created_date" class="form-label">Created Date</label>
                                    <input type="date" class="form-control" id="created_date" x-model="asset.created_date" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="modified_date" class="form-label">Modified Date</label>
                                    <input type="date" class="form-control" id="modified_date" x-model="asset.modified_date" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="history_tracking" class="form-label">History (Audit) Tracking</label>
                                    <textarea class="form-control" id="history_tracking" x-model="asset.history_tracking" readonly></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" @click="saveAsset()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>&copy; 2024 IoTix Asset Management. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="#" class="text-white me-3">Privacy Policy</a>
                    <a href="#" class="text-white">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
 document.addEventListener('alpine:init', () => {
    Alpine.store('assetSearch', {
        selectedAsset: null
    })
})

function assetSearch() {
    return {
        query: '',
        results: [],
        advancedResults: [],
        loading: false,
        showDropdown: false,
        showAdvancedSearch: false,
        modal: null,
        criteria: [{ field: '', operator: '=', value: '' }],
        booleanOptions: {
            secure_location: null,
            remote_access: null,
            syslog: null,
            obsolete: null
        },
        useCustomQuery: false,
        customQuery: '',
        selectedAttributes: ['asset_type', 'manufacturer', 'site_name', 'criticality', 'ip_address'],
        currentPage: 1,
        pageSize: 10,
        totalPages: 1,
        sortField: 'criticality.keyword',
        sortOrder: 'desc',

        init() {
            this.modal = new bootstrap.Modal(document.getElementById('assetModal'));
        },

        search() {
            if (this.query.length < 2) {
                this.results = [];
                this.showDropdown = false;
                return;
            }
            this.loading = true;
            fetch(`/search?query=${encodeURIComponent(this.query)}`)
                .then(response => response.json())
                .then(data => {
                    this.results = data.assets;
                    this.loading = false;
                    this.showDropdown = true;
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.loading = false;
                });
        },

        performAdvancedSearch(event = null) {
            if (event) event.preventDefault();
            
            this.loading = true;
            const payload = {
                criteria: this.criteria.filter(c => c.field && c.operator && c.value),
                boolean_options: this.booleanOptions,
                custom_query: this.useCustomQuery ? this.customQuery : null,
                page: this.currentPage,
                size: this.pageSize,
                sort_field: this.sortField,
                sort_order: this.sortOrder
            };

            console.log('Sending advanced search payload:', payload);

            fetch('/advanced-search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received advanced search results:', data);
                if (data.detail) {
                    console.error('Error in advanced search:', data.detail);
                    this.advancedResults = [];
                } else {
                    this.advancedResults = data.assets || [];
                    this.totalPages = data.total_pages || 1;
                    this.currentPage = data.page || 1;
                }
                this.loading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                this.advancedResults = [];
                this.loading = false;
            });
        },

        selectAsset(asset) {
            this.showDropdown = false;
            this.query = '';
            this.openModal(asset);
        },

        openModal(asset) {
            if (asset) {
                Alpine.store('assetSearch').selectedAsset = asset;
                this.modal.show();
                window.dispatchEvent(new CustomEvent('update-asset-modal'));
            }
        },

        getAssetTypeIcon(assetType) {
            const iconMap = {
                'PLC': 'fas fa-microchip',
                'Server': 'fas fa-server',
                'Router': 'fas fa-router',
                'Switch': 'fas fa-network-wired',
                'Workstation': 'fas fa-desktop',
                'Printer': 'fas fa-print',
                'Camera': 'fas fa-video',
                'Sensor': 'fas fa-thermometer-half',
                'Mobile Device': 'fas fa-mobile-alt',
                'Firewall': 'fas fa-shield-alt',
                'Storage': 'fas fa-hdd',
                'VPN': 'fas fa-lock',
                'Access Point': 'fas fa-wifi',
                'IoT Device': 'fas fa-microchip',
                'SCADA': 'fas fa-industry'
            };
            return iconMap[assetType] || 'fas fa-cube';
        },

        getAssetTypeIconClass(assetType) {
            const classMap = {
                'PLC': 'bg-plc',
                'Server': 'bg-server',
                'Router': 'bg-router',
                'Switch': 'bg-switch',
                'Workstation': 'bg-workstation',
                'Printer': 'bg-printer',
                'Camera': 'bg-camera',
                'Sensor': 'bg-sensor',
                'Mobile Device': 'bg-mobile',
                'Firewall': 'bg-firewall',
                'Storage': 'bg-storage',
                'VPN': 'bg-vpn',
                'Access Point': 'bg-access-point',
                'IoT Device': 'bg-iot',
                'SCADA': 'bg-scada'
            };
            return classMap[assetType] || 'bg-default';
        },

        getCriticalityClass(criticality) {
            const classMap = {
                'Low': 'criticality-low',
                'Medium': 'criticality-medium',
                'High': 'criticality-high',
                'Critical': 'criticality-critical',
            };
            return classMap[criticality] || '';
        },

        getMatchedField(asset) {
            const excludeFields = ['id', 'criticality'];
            const query = this.query.toLowerCase();

            for (const [key, value] of Object.entries(asset)) {
                if (excludeFields.includes(key)) continue;
                if (value && value.toString().toLowerCase().includes(query)) {
                    const label = key.split(/(?=[A-Z])|_/).map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                    return `${label}: ${value}`;
                }
            }
            return null;
        },

        toggleAdvancedSearch() {
            this.showAdvancedSearch = !this.showAdvancedSearch;
            if (this.showAdvancedSearch) {
                this.results = [];
                this.showDropdown = false;
            }
        },

        getGridHeaders() {
            return this.selectedAttributes.map(attr => 
                attr.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
            );
        },

        changePage(newPage) {
            if (newPage >= 1 && newPage <= this.totalPages) {
                this.currentPage = newPage;
                this.performAdvancedSearch();
            }
        },

        changeSort(field) {
            if (this.sortField === field) {
                this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortOrder = 'asc';
            }
            this.performAdvancedSearch();
        },

        addCriterion() {
            this.criteria.push({ field: '', operator: '=', value: '' });
        },

        removeCriterion(index) {
            this.criteria.splice(index, 1);
        },

        resetAdvancedSearch() {
            this.criteria = [{ field: '', operator: '=', value: '' }];
            this.booleanOptions = {
                secure_location: null,
                remote_access: null,
                syslog: null,
                obsolete: null
            };
            this.useCustomQuery = false;
            this.customQuery = '';
            this.currentPage = 1;
            this.sortField = 'criticality.keyword';
            this.sortOrder = 'desc';
            this.advancedResults = [];
        }
    }
}







function assetModalData() {
    return {
        asset: {},
        init() {
            this.updateAssetData();
            window.addEventListener('update-asset-modal', () => this.updateAssetData());
        },
        updateAssetData() {
            const selectedAsset = Alpine.store('assetSearch').selectedAsset;
            if (selectedAsset) {
                this.asset = { ...selectedAsset };
                this.formatDates();
            }
        },
        formatDates() {
            const dateFields = [
                'installation_date',
                'last_maintenance_date',
                'next_scheduled_maintenance',
                'warranty_expiration_date',
                'support_contract_expiration',
                'last_vulnerability_scan_date',
                'created_date',
                'modified_date'
            ];
            
            dateFields.forEach(field => {
                if (this.asset[field]) {
                    this.asset[field] = this.formatDate(this.asset[field]);
                }
            });
        },
        formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString; // Return original string if invalid date
            }
            return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
        },
        saveAsset() {
            console.log('Saving asset:', this.asset);
            // Implement your save logic here
            
            // After saving, update the store
            Alpine.store('assetSearch').selectedAsset = { ...this.asset };
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('assetModal'));
            modal.hide();
        }
    }
}

    </script>
</body>
</html>