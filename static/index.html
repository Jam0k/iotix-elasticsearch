<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoTix Asset Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .dropdown-results {
            position: absolute;
            width: 100%;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 0 0 0.25rem 0.25rem;
            max-height: 300px;
            overflow-y: auto;
        }
        mark {
            background-color: yellow;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container mt-5" x-data="assetSearch()">
        <h1 class="mb-4">IoTix Asset Search</h1>
        <div class="mb-4 position-relative">
            <input 
                type="text" 
                x-model="query" 
                @input.debounce.300ms="search()"
                @focus="showDropdown = true"
                @blur="setTimeout(() => showDropdown = false, 200)"
                placeholder="Search assets..." 
                class="form-control"
            >
            <div x-show="showDropdown && results.length > 0" class="dropdown-results">
                <ul class="list-group">
                    <template x-for="asset in results.slice(0, 10)" :key="asset.id">
                        <li class="list-group-item" @mousedown="selectAsset(asset)">
                            <div x-html="highlightMatch(asset.asset_type, query)"></div>
                            <small class="text-muted" x-html="highlightMatch(`${asset.serial_number || ''} | ${asset.mac_address || ''}`, query)"></small>
                            <template x-for="(value, key) in asset" :key="key">
                                <div x-show="shouldShowField(key, value)">
                                    <small x-html="formatFieldValue(key, value)"></small>
                                </div>
                            </template>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
        <div id="selected-asset" class="card" x-show="selectedAsset">
            <div class="card-body">
                <h5 class="card-title" x-text="selectedAsset?.asset_type"></h5>
                <h6 class="card-subtitle mb-2 text-muted" x-text="selectedAsset ? `${selectedAsset.serial_number || ''} | ${selectedAsset.mac_address || ''}` : ''"></h6>
                <p class="card-text" x-text="selectedAsset ? `Manufacturer: ${selectedAsset.manufacturer || ''}` : ''"></p>
                <p class="card-text" x-text="selectedAsset ? `Site: ${selectedAsset.site_name || ''}` : ''"></p>
                <p class="card-text" x-text="selectedAsset ? `IP: ${selectedAsset.ip_address || ''}` : ''"></p>
                <p class="card-text" x-text="selectedAsset ? `Status: ${selectedAsset.asset_status || ''}` : ''"></p>
                <p class="card-text" x-text="selectedAsset ? `Criticality: ${selectedAsset.criticality || ''}` : ''"></p>
                <button @click="openModal()" class="btn btn-primary">View Details</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="assetModal" tabindex="-1" aria-labelledby="assetModalLabel" aria-hidden="true" x-data>
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assetModalLabel" x-text="$store.assetSearch.selectedAsset?.asset_type"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <template x-if="$store.assetSearch.selectedAsset">
                        <div>
                            <template x-for="(value, key) in $store.assetSearch.selectedAsset" :key="key">
                                <p>
                                    <strong x-text="`${key}: `"></strong>
                                    <span x-text="value !== null && value !== undefined ? value : 'N/A'"></span>
                                </p>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('assetSearch', {
                selectedAsset: null
            })
        })

        function assetSearch() {
            return {
                query: '',
                results: [],
                loading: false,
                showDropdown: false,
                modal: null,
                init() {
                    this.modal = new bootstrap.Modal(document.getElementById('assetModal'));
                },
                search() {
                    if (this.query.length < 2) {
                        this.results = [];
                        return;
                    }
                    this.loading = true;
                    fetch(`/search?query=${encodeURIComponent(this.query)}`)
                        .then(response => response.json())
                        .then(data => {
                            this.results = data.assets.filter(asset => 
                                Object.entries(asset).some(([key, value]) => {
                                    if (value === null || value === undefined) return false;
                                    return value.toString().toLowerCase().includes(this.query.toLowerCase());
                                })
                            );
                            this.loading = false;
                            this.showDropdown = true;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            this.loading = false;
                        });
                },
                selectAsset(asset) {
                    Alpine.store('assetSearch').selectedAsset = asset;
                    this.query = asset.asset_type;
                    this.showDropdown = false;
                },
                openModal() {
                    if (Alpine.store('assetSearch').selectedAsset) {
                        this.modal.show();
                    }
                },
                get selectedAsset() {
                    return Alpine.store('assetSearch').selectedAsset;
                },
                highlightMatch(text, query) {
                    if (!query || text === null || text === undefined) return text;
                    const regex = new RegExp(`(${query})`, 'gi');
                    return text.toString().replace(regex, '<mark>$1</mark>');
                },
                shouldShowField(key, value) {
                    return key !== 'asset_type' && 
                           key !== 'serial_number' && 
                           key !== 'mac_address' && 
                           value !== null && 
                           value !== undefined && 
                           value.toString().toLowerCase().includes(this.query.toLowerCase());
                },
                formatFieldValue(key, value) {
                    if (value === null || value === undefined) return '';
                    return `${key}: ${this.highlightMatch(value.toString(), this.query)}`;
                }
            }
        }
    </script>
</body>
</html>